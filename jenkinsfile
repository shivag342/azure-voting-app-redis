pipeline
{
    agent any 
    stages {
    
        stage('Build new image and push to ACR'){
            
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'acr-credentials',
                    usernameVariable: 'ACR_ID',
                    passwordVariable: 'ACR_PASSWORD'
                )]) {
                        sh """
                        WEB_IMAGE_NAME="${ACR_LOGINSERVER}/azure-vote-front:kube${BUILD_NUMBER}"
                        docker build -t ${WEB_IMAGE_NAME} ./azure-vote
                        docker login ${ACR_LOGINSERVER} -u ${ACR_ID} -p ${ACR_PASSWORD}
                        docker push $WEB_IMAGE_NAME
                        """
                }
             }
        }

        stage('Deploy Application to AKS cluster'){
            
            steps {
                    sh """
                                
                        kubectl apply -f azure-vote-all-in-one-redis.yaml
                        """
                    
             }
        }

        stage('Update kubernetes deployment with new image'){
            steps {                        
                        sh """
                            WEB_IMAGE_NAME="${ACR_LOGINSERVER}/azure-vote-front:kube${BUILD_NUMBER}"
                            kubectl set image deployment/azure-vote-front azure-vote-front=${WEB_IMAGE_NAME}
                        """
                   
                
            }
        }
    
    }
}